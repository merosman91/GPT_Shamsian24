<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø´Ù…Ø³ÙŠÙ† â€” Ø­Ø§Ø³Ø¨Ø© Ù…Ù†Ø¸ÙˆÙ…Ø© Ø´Ù…Ø³ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø©</title>

<!-- Chart.js Ùˆ jsPDF Ù…Ù† CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  /* ====== Variables ====== */
  :root{
    --bg: #f6f8fb;
    --card: #ffffff;
    --primary: #0b69ff;
    --accent: #ff9800;
    --muted: #6b7280;
    --success:#16a34a;
    --danger:#ef4444;
    --glass: rgba(255,255,255,0.7);
    --radius: 12px;
  }
  [data-theme="dark"]{
    --bg: #0b1220;
    --card: #071126;
    --primary: #60a5fa;
    --accent: #f97316;
    --muted: #9ca3af;
    --glass: rgba(10,20,30,0.5);
  }

  /* ====== Base ====== */
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family: 'Tajawal', system-ui, -apple-system, Roboto, 'Segoe UI', Arial; background:var(--bg); color:var(--muted)}
  .wrap{max-width:1100px;margin:18px auto;padding:18px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#ffd27f);display:grid;place-items:center;color:#fff;font-weight:800;font-size:20px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
  h1{margin:0;font-size:20px;color:var(--primary)}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  /* ====== Controls Grid ====== */
  .grid{display:grid;gap:12px;margin-top:12px}
  .top-grid{grid-template-columns: 1fr; }
  .two-col{grid-template-columns: 1fr 360px; }
  .three-col{grid-template-columns: 1fr 360px 280px; }

  @media(min-width:980px){ .grid.top-grid{grid-template-columns: 1fr 360px} .grid.two-col{grid-template-columns: 1fr 360px} }
  @media(min-width:1200px){ .grid.three-col{grid-template-columns: 1fr 360px 280px } }

  .card{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:0 8px 30px rgba(2,6,23,0.06);border:1px solid rgba(0,0,0,0.03)}
  label{display:block;font-weight:700;color:var(--primary);font-size:13px;margin-bottom:6px}
  select,input,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);font-size:14px}
  .small{font-size:13px;padding:8px}

  .row{display:flex;gap:8px;flex-wrap:wrap}
  .col{flex:1;min-width:120px}
  .muted{color:var(--muted);font-size:13px}

  /* devices table */
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:center;color:var(--muted)}
  th{background:linear-gradient(90deg, rgba(11,105,255,0.12), rgba(255,152,0,0.06));font-weight:700;color:var(--primary)}
  .actions button{margin:4px; padding:6px 8px;border-radius:6px;border:none;cursor:pointer}
  .btn{display:inline-block;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn-primary{background:var(--primary);color:white}
  .btn-accent{background:var(--accent);color:white}
  .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}

  .small-muted{font-size:12px;color:var(--muted)}
  .hint{font-size:13px;color:var(--muted);margin-top:6px}

  /* result area */
  .result-grid{display:grid;grid-template-columns: repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:12px}
  .result-card{background:linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04)}
  .result-card h3{margin:0;font-size:14px;color:var(--muted)}
  .result-card p{margin:6px 0 0 0;font-weight:800;color:var(--primary)}

  /* interactive touches */
  .btn:active{transform:translateY(1px)}
  .device-row{transition:transform .18s ease, box-shadow .18s;cursor:pointer}
  .device-row:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(2,6,23,0.06)}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal{background:var(--card);padding:18px;border-radius:12px;max-width:520px;width:94%;box-shadow:0 10px 40px rgba(2,6,23,0.2)}
  .modal h2{margin:0 0 8px 0;color:var(--primary)}
  .modal p{color:var(--muted);font-size:14px}

  /* toggles row */
  .toggles{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .switch{display:inline-flex;align-items:center;padding:6px 8px;border-radius:999px;background:rgba(0,0,0,0.03)}
  .switch input{margin-left:8px}

  /* faq */
  .faq h4{margin:0 0 6px 0;color:var(--primary)}
  .video{width:100%;aspect-ratio:16/9;background:#000;border-radius:8px;overflow:hidden;display:grid;place-items:center;color:#fff}
  .tiny{font-size:12px;color:var(--muted)}

  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <div class="brand">
      <div class="logo">Ø´Ø³</div>
      <div>
        <h1>Ø´Ù…Ø³ÙŠÙ† â€” Ø­Ø§Ø³Ø¨Ø© Ù…Ù†Ø¸ÙˆÙ…Ø§Øª Ø´Ù…Ø³ÙŠØ©</h1>
        <p class="lead">Ù…ØªØ¬Ø§ÙˆØ¨Ø©ØŒ ØªÙØ§Ø¹Ù„ÙŠØ©ØŒ ÙˆØªØ¯Ø¹Ù… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆÙ…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</p>
      </div>
    </div>

    <div class="toggles">
      <div class="switch" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">
        <label class="tiny">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</label>
        <input type="checkbox" id="darkToggle">
      </div>

      <div class="switch" title="Ø§Ù„Ù„ØºØ©">
        <label class="tiny">EN / Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</label>
        <select id="langToggle" style="padding:6px;border-radius:8px;">
          <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="en">English</option>
        </select>
      </div>
    </div>
  </header>

  <!-- MAIN GRID -->
  <div class="grid three-col">
    <!-- LEFT: Devices & controls -->
    <div class="card">
      <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="reportTitle" placeholder="Ù…Ø«Ø§Ù„: Ø­Ø³Ø§Ø¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù†Ø²Ù„" />

      <label>Ø£Ø¶Ù Ø¬Ù‡Ø§Ø²</label>
      <div class="row">
        <div style="flex:1">
          <select id="deviceCategory" class="small">
            <option value="">Ø§Ø®ØªØ± ÙØ¦Ø©</option>
            <option value="lighting">Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©</option>
            <option value="cooling">ØªØ¨Ø±ÙŠØ¯</option>
            <option value="kitchen">Ù…Ø·Ø¨Ø®</option>
            <option value="water">Ù…ÙŠØ§Ù‡</option>
            <option value="electronics">Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</option>
          </select>
        </div>
        <div style="flex:2">
          <select id="deviceType" class="small">
            <option value="">Ø§Ø®ØªØ± Ø¬Ù‡Ø§Ø²...</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col">
          <label>Ø§Ù„Ø¹Ø¯Ø¯</label>
          <input id="deviceCount" type="number" min="1" value="1" />
        </div>
        <div class="col">
          <label>Ø³Ø§Ø¹Ø§Øª ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠØ§Ù‹</label>
          <input id="deviceHours" type="number" min="0.25" step="0.25" value="1" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="addDeviceBtn" class="btn btn-primary">â• Ø£Ø¶Ù</button>
        <button id="clearAllBtn" class="btn btn-ghost">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </div>

      <div class="hint tiny">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ØµÙ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø£Ùˆ Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡.</div>

      <table id="devicesTable" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©">
        <thead>
          <tr><th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>ÙˆØ§Ø·</th><th>Ø¹Ø¯Ø¯</th><th>Ø³Ø§Ø¹Ø§Øª</th><th>Wh/ÙŠÙˆÙ…</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
        </thead>
        <tbody id="devicesTbody"></tbody>
      </table>

      <div style="margin-top:10px" class="tiny muted">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ù…Ø­ÙÙˆØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ (LocalStorage).</div>
    </div>

    <!-- MIDDLE: System specs -->
    <div class="card">
      <h3 style="margin-top:0">Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
      <div class="row">
        <div class="col">
          <label>Ø³Ø§Ø¹Ø§Øª Ø°Ø±ÙˆØ© Ø´Ù…Ø³ Ù…ØªÙˆÙ‚Ø¹Ø©/ÙŠÙˆÙ…</label>
          <input id="sunHours" type="number" min="1" max="10" step="0.1" value="5" />
        </div>
        <div class="col">
          <label>Ù‚Ø¯Ø±Ø© Ø§Ù„Ù„ÙˆØ­ (W)</label>
          <select id="panelW">
            <option value="100">100 W</option><option value="200">200 W</option><option value="300">300 W</option><option value="400" selected>400 W</option><option value="500">500 W</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col">
          <label>Ø¬Ù‡Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù… (V)</label>
          <select id="systemVoltage"><option value="12">12 V</option><option value="24" selected>24 V</option><option value="48">48 V</option></select>
        </div>
        <div class="col">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©</label>
          <select id="batteryType">
            <option value="lead">Ø±ØµØ§Øµ Ø­Ù…Ø¶ (Lead Acid)</option>
            <option value="agm">AGM</option>
            <option value="gel">Ø¬ÙÙŠÙ„</option>
            <option value="li">Ù„ÙŠØ«ÙŠÙˆÙ… Ø£ÙŠÙˆÙ† (Li-ion)</option>
          </select>
        </div>
      </div>

      <div style="margin-top:8px" class="row">
        <div class="col">
          <label>Ø³Ø¹Ø© Ø¨Ø·Ø§Ø±ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ah)</label>
          <select id="batteryAh"><option value="100">100 Ah</option><option value="150">150 Ah</option><option value="200" selected>200 Ah</option><option value="300">300 Ah</option></select>
        </div>
        <div class="col">
          <label>Ø¹Ù…Ù‚ ØªÙØ±ÙŠØº Ù…Ù‚ØªØ±Ø­ (DoD)</label>
          <select id="batteryDoD"><option value="0.5">50%</option><option value="0.6">60%</option><option value="0.8" selected>80%</option></select>
        </div>
      </div>

      <div style="margin-top:8px" class="row">
        <div class="col">
          <label>Ø·ÙˆÙ„ Ø³Ù„Ùƒ Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ù…ØªØ±)</label>
          <input id="wireLength" type="number" min="0" value="10" />
        </div>
        <div class="col">
          <label>Ù‚Ø·Ø± Ø§Ù„Ø³Ù„Ùƒ (mmÂ²)</label>
          <select id="wireSize"><option value="2.5">2.5</option><option value="4">4</option><option value="6">6</option><option value="10" selected>10</option></select>
        </div>
      </div>

      <div style="margin-top:8px" class="row">
        <div class="col">
          <label>Ø£Ø«Ø± Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)</label>
          <input id="ambientTemp" type="number" value="25" />
          <div class="tiny hint">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© ØªÙØ¤Ø«Ø± Ø¹Ù„Ù‰ ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ø­ (Ù‚ÙŠÙ…Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©).</div>
        </div>
        <div class="col">
          <label>ØªÙƒÙ„ÙØ© Ù…ØªÙˆØ³Ø·Ø© Ù„Ù„ÙˆØ­Ø© (USD)</label>
          <input id="panelPrice" type="number" step="0.1" value="120" />
        </div>
      </div>

      <div style="margin-top:10px" class="row">
        <button id="calcSystemBtn" class="btn btn-accent">âœ… Ø§Ø­Ø³Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        <button id="savePdfBtn" class="btn btn-ghost">ğŸ–¨ï¸ Ø­ÙØ¸ ØªÙ‚Ø±ÙŠØ± PDF</button>
      </div>

      <div class="hint tiny" style="margin-top:8px">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶Ø§Øª (DoDØŒ ÙƒÙØ§Ø¡Ø©...)</div>
    </div>

    <!-- RIGHT: Results & charts -->
    <div class="card">
      <h3 style="margin-top:0">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ & Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª</h3>

      <div class="result-grid" id="summaryCards">
        <div class="result-card"><h3>Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3><p id="dailyKwh">-</p></div>
        <div class="result-card"><h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ø­</h3><p id="panelsCount">-</p></div>
        <div class="result-card"><h3>Ø³Ø¹Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© (Ah)</h3><p id="batteryNeededAh">-</p></div>
        <div class="result-card"><h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª</h3><p id="batteryCount">-</p></div>
      </div>

      <canvas id="consumptionChart" style="margin-top:12px;max-height:240px"></canvas>

      <div style="margin-top:12px">
        <h4 class="muted" style="margin:0">Ù†ØµØ§Ø¦Ø­ Ø°ÙƒÙŠØ©</h4>
        <ul id="smartTips" class="tiny">
          <li>Ø£Ø¶Ù Ø£Ø­Ù…Ø§Ù„ Ø¨Ø¯Ø¡ Ø¹Ø§Ù„ÙŠØ© (Ù…Ø¶Ø®Ø§Øª/Ø«Ù„Ø§Ø¬Ø§Øª) Ù…Ø¹ Ù‡Ø§Ù…Ø´ Ø¥Ù†ÙØ±ØªØ±.</li>
        </ul>
      </div>

      <div style="margin-top:12px">
        <h4 class="muted" style="margin:0">Ù…Ø´Ø§Ø±ÙƒØ©</h4>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="shareWhatsapp" class="btn">ÙˆØ§ØªØ³Ø§Ø¨</button>
          <button id="shareEmail" class="btn btn-ghost">Ø¨Ø±ÙŠØ¯</button>
        </div>
      </div>
    </div>
  </div>

  <!-- EDUCATION & FAQ -->
  <div class="grid top-grid" style="margin-top:12px">
    <div class="card">
      <h3 style="margin-top:0">ØªØ¹Ù„ÙŠÙ… â€” Ø§Ù„ØªÙˆØµÙŠÙ„ØŒ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ…ØŒ ÙÙŠØ¯ÙŠÙˆ</h3>
      <div>
        <h4 style="margin-bottom:4px">Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§Ù„ÙŠ vs Ø§Ù„ØªÙˆØ§Ø²ÙŠ</h4>
        <p class="tiny">Ø§Ù„ØªÙˆØ§Ù„ÙŠ ÙŠØ²ÙŠØ¯ Ø§Ù„ÙÙˆÙ„ØªÙŠØ©ØŒ Ø§Ù„ØªÙˆØ§Ø²ÙŠ ÙŠØ²ÙŠØ¯ Ø§Ù„Ø³Ø¹Ø© (Ø§Ù„Ø£Ù…Ø¨ÙŠØ±). Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø·Ø§Ø±ÙŠØ§Øª.</p>

        <h4 style="margin-bottom:4px;margin-top:8px">Ø§Ù„ÙÙˆÙ„ØªØŒ Ø§Ù„Ø£Ù…Ø¨ÙŠØ±ØŒ ÙˆØ§Ù„ÙˆØ§Øª</h4>
        <p class="tiny">W = V Ã— A. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ø¬Ù‡Ø§Ø² 240W ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ 24V: Ø§Ù„ØªÙŠØ§Ø± = 240 / 24 = 10A.</p>

        <h4 style="margin-top:8px">ÙÙŠØ¯ÙŠÙˆ ØªØ¹Ù„ÙŠÙ…ÙŠ</h4>
        <div class="video">
          <!-- Ù…Ø¤Ø´Ø± Ù„Ù…Ù‚Ø·Ø¹ ØªØ¹Ù„ÙŠÙ…ÙŠ (ÙŠÙ…ÙƒÙ† ØªØ¶Ù…ÙŠÙ† ÙÙŠØ¯ÙŠÙˆ Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹) -->
          <div style="padding:8px;text-align:center">
            ÙÙŠØ¯ÙŠÙˆ ØªÙˆØ¶ÙŠØ­ÙŠ: ØªØ±ÙƒÙŠØ¨ Ù†Ø¸Ø§Ù… ØµØºÙŠØ± â€” (Ù…ÙƒØ§Ù† Ù…Ø¨Ø¯Ø¦ÙŠ)
          </div>
        </div>
      </div>
    </div>

    <div class="card faq">
      <h3 style="margin-top:0">Ø£Ø³Ø¦Ù„Ø© Ø´Ø§Ø¦Ø¹Ø©</h3>
      <div>
        <h4>Ù‡Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ©ØŸ</h4>
        <p class="tiny">Ù„Ø§ â€” Ù‡Ø°Ù‡ ØªÙ‚Ø¯ÙŠØ±Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„ØªØ®Ø·ÙŠØ·. Ù„ÙØ­Øµ Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ø³ØªØ¹Ù† Ø¨ÙÙ†ÙŠ Ù…Ø®ØªØµ.</p>
        <h4>Ù‡Ù„ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ù…ÙØ­Ø¯Ø¯Ø©ØŸ</h4>
        <p class="tiny">ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¦Ù…Ø© Ù…ÙˆØ¯ÙŠÙ„Ø§Øª ÙˆØ£Ø³Ø¹Ø§Ø± Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø¨Ø¯Ù‚Ø© â€” Ø®ÙŠØ§Ø± Ù‚Ø§Ø¯Ù….</p>
      </div>
    </div>
  </div>

  <footer>Ù…ØµÙ…Ù… Ø¨ÙˆØ§Ø³Ø·Ø© Ø´Ù…Ø³ÙŠÙ† â€” Ø§Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙˆØ´Ø§Ø±ÙƒÙ†ÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</footer>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h2 id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø²</h2>
    <div id="modalBody"></div>
    <div style="margin-top:12px;text-align:left">
      <button id="modalClose" class="btn btn-ghost">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script>
/* ====== Utility & Data ====== */
const deviceCatalog = {
  lighting: [
    {name:'Ù„Ù…Ø¨Ø© LED', watt:10, img: 'ğŸ’¡', detail: 'Ù„Ù…Ø¨Ø© Ø¥Ø¶Ø§Ø¡Ø© Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©ØŒ Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ù„Ø¥Ø¶Ø§Ø¡Ø© Ø§Ù„Ø¹Ø§Ù…Ø©.'},
    {name:'Ø¥Ù†Ø§Ø±Ø© Ø¯Ø§Ø®Ù„ÙŠØ©', watt:20, img: 'ğŸ’¡', detail: 'Ù…ØµØ¨Ø§Ø­ Ø¯Ø§Ø®Ù„ÙŠ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ.'}
  ],
  cooling: [
    {name:'Ù…Ø±ÙˆØ­Ø© Ø³Ù‚Ù', watt:100, img:'ğŸ’¨', detail:'Ù…Ø±ÙˆØ­Ø© Ø³Ù‚Ù 100W ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹.'},
    {name:'Ù…ÙƒÙŠÙ Ù†Ø³Ù…Ø© 6000', watt:250, img:'â„ï¸', detail:'Ù…ÙƒÙŠÙ ØµØºÙŠØ± 6000 ÙˆØ­Ø¯Ø©ØŒ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ ØªÙ‚Ø±ÙŠØ¨ÙŠ 250W.'}
  ],
  kitchen: [
    {name:'Ø«Ù„Ø§Ø¬Ø© ØµØºÙŠØ±Ø©', watt:150, img:'ğŸ§Š', detail:'Ø«Ù„Ø§Ø¬Ø© Ù…Ù†Ø²Ù„ÙŠØ© Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø­Ø¬Ù….'},
    {name:'Ù…ÙŠÙƒØ±ÙˆÙˆÙŠÙ', watt:800, img:'ğŸ”¥', detail:'Ù…ÙŠÙƒØ±ÙˆÙˆÙŠÙ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¤Ù‚Øª.'}
  ],
  water: [
    {name:'Ù…Ø¶Ø®Ø© Ù…ÙŠØ§Ù‡ 1 Ø­ØµØ§Ù†', watt:750, img:'ğŸ’§', detail:'Ù…Ø¶Ø®Ø© Ù…ÙŠØ§Ù‡ 1 Ø­ØµØ§Ù†ØŒ ØªÙŠØ§Ø± Ø¨Ø¯Ø¡ Ø£Ø¹Ù„Ù‰.'}
  ],
  electronics: [
    {name:'ØªÙ„ÙØ§Ø² LED', watt:100, img:'ğŸ“º', detail:'ØªÙ„ÙØ§Ø² LED Ø¨Ø­Ø¬Ù… Ù…ØªÙˆØ³Ø·.'},
    {name:'Ø­Ø§Ø³ÙˆØ¨ Ù…Ø­Ù…ÙˆÙ„', watt:60, img:'ğŸ’»', detail:'Ù„Ø§Ø¨ØªÙˆØ¨ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ.'}
  ]
};

const batterySpecs = {
  lead: {eff:0.85, dod:0.5, lifeYears:4},
  agm: {eff:0.88, dod:0.6, lifeYears:5},
  gel: {eff:0.86, dod:0.6, lifeYears:5},
  li: {eff:0.95, dod:0.9, lifeYears:10}
};

/* ====== DOM refs ====== */
const deviceCategory = document.getElementById('deviceCategory');
const deviceType = document.getElementById('deviceType');
const deviceCount = document.getElementById('deviceCount');
const deviceHours = document.getElementById('deviceHours');
const addDeviceBtn = document.getElementById('addDeviceBtn');
const clearAllBtn = document.getElementById('clearAllBtn');
const devicesTbody = document.getElementById('devicesTbody');

const sunHoursInput = document.getElementById('sunHours');
const panelWInput = document.getElementById('panelW');
const systemVoltageInput = document.getElementById('systemVoltage');
const batteryTypeSelect = document.getElementById('batteryType');
const batteryAhSelect = document.getElementById('batteryAh');
const batteryDoDSelect = document.getElementById('batteryDoD');
const wireLengthInput = document.getElementById('wireLength');
const wireSizeSelect = document.getElementById('wireSize');
const ambientTempInput = document.getElementById('ambientTemp');
const panelPriceInput = document.getElementById('panelPrice');

const calcSystemBtn = document.getElementById('calcSystemBtn');
const savePdfBtn = document.getElementById('savePdfBtn');

const dailyKwhEl = document.getElementById('dailyKwh');
const panelsCountEl = document.getElementById('panelsCount');
const batteryNeededAhEl = document.getElementById('batteryNeededAh');
const batteryCountEl = document.getElementById('batteryCount');
const summaryCards = document.getElementById('summaryCards');

const smartTipsEl = document.getElementById('smartTips');

const shareWhatsapp = document.getElementById('shareWhatsapp');
const shareEmail = document.getElementById('shareEmail');
const reportTitleInput = document.getElementById('reportTitle');

const modalBackdrop = document.getElementById('modalBackdrop');
const modalBody = document.getElementById('modalBody');
const modalClose = document.getElementById('modalClose');

const darkToggle = document.getElementById('darkToggle');
const langToggle = document.getElementById('langToggle');

/* ====== Chart ====== */
const ctx = document.getElementById('consumptionChart').getContext('2d');
let consumptionChart = new Chart(ctx, {
  type: 'bar',
  data: { labels: ['Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ/ÙŠÙˆÙ…','Ù‚Ø¯Ø±Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ø­ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©'], datasets: [{label:'Ù‚ÙŠÙ…Ø©',data:[0,0],backgroundColor:['rgba(11,105,255,0.7)','rgba(255,152,0,0.7)']}] },
  options:{responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}
});

/* ====== State & persistence ====== */
let devices = JSON.parse(localStorage.getItem('shamsin.devices') || '[]');
let userSettings = JSON.parse(localStorage.getItem('shamsin.settings') || '{}');

/* init UI from saved */
function init() {
  // populate category types
  deviceCategory.addEventListener('change', (e)=>{
    const cat = e.target.value;
    deviceType.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¬Ù‡Ø§Ø²...</option>';
    if(!cat) return;
    (deviceCatalog[cat]||[]).forEach(d=>{
      const opt = document.createElement('option');
      opt.value = JSON.stringify({name:d.name,watt:d.watt});
      opt.textContent = `${d.img || ''} ${d.name} (${d.watt}W)`;
      opt.dataset.w = d.watt;
      deviceType.appendChild(opt);
    });
  });

  // load saved devices
  renderDevices();

  // load settings
  if(userSettings.dark) document.documentElement.setAttribute('data-theme','dark'), darkToggle.checked=true;
  if(userSettings.lang) langToggle.value = userSettings.lang;
  if(userSettings.reportTitle) reportTitleInput.value = userSettings.reportTitle;

  // event toggles
  darkToggle.addEventListener('change', (e)=>{
    if(e.target.checked){ document.documentElement.setAttribute('data-theme','dark'); userSettings.dark=true; }
    else { document.documentElement.removeAttribute('data-theme'); userSettings.dark=false; }
    saveSettings();
  });
  langToggle.addEventListener('change', (e)=>{ userSettings.lang = e.target.value; saveSettings(); /* simple: not switching text content here */ });

  // modal close
  modalClose.addEventListener('click', ()=>{ modalBackdrop.style.display='none' });
  modalBackdrop.addEventListener('click', (ev)=>{ if(ev.target===modalBackdrop) modalBackdrop.style.display='none' });

  // bind actions
  addDeviceBtn.addEventListener('click', onAddDevice);
  clearAllBtn.addEventListener('click', onClearAll);
  calcSystemBtn.addEventListener('click', calculateSystem);
  savePdfBtn.addEventListener('click', savePdf);
  shareWhatsapp.addEventListener('click', shareToWhatsapp);
  shareEmail.addEventListener('click', shareToEmail);
}
init();

/* ====== Devices functions ====== */
function onAddDevice(){
  const sel = deviceType.value;
  if(!sel){ alert('Ø§Ø®ØªØ± Ø¬Ù‡Ø§Ø²Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©'); return; }
  const parsed = JSON.parse(sel);
  const count = Math.max(1, parseInt(deviceCount.value) || 1);
  const hrs = Math.max(0.25, parseFloat(deviceHours.value) || 1);
  const device = {name: parsed.name, power: parsed.watt || parsed.w, count, hrs};
  devices.push(device);
  saveDevices();
  renderDevices();
}

function renderDevices(){
  devicesTbody.innerHTML = '';
  devices.forEach((d, idx) => {
    const tr = document.createElement('tr');
    const whPerDay = (d.power * d.count * d.hrs);
    tr.className = 'device-row';
    tr.innerHTML = `
      <td style="text-align:right">${d.name}</td>
      <td>${d.power}</td>
      <td>${d.count}</td>
      <td>${d.hrs}</td>
      <td>${(whPerDay/1000).toFixed(2)} kWh</td>
      <td class="actions">
        <button onclick="showDevice(${idx})" class="btn">â„¹ï¸</button>
        <button onclick="editDevice(${idx})" class="btn btn-ghost">âœï¸</button>
        <button onclick="removeDevice(${idx})" class="btn" style="background:var(--danger);color:white">ğŸ—‘ï¸</button>
      </td>
    `;
    devicesTbody.appendChild(tr);
  });
}

function showDevice(i){
  const d = devices[i];
  modalBody.innerHTML = `<h3>${d.name}</h3><p>Ù‚Ø¯Ø±Ø©: ${d.power} W<br>Ø§Ù„Ø¹Ø¯Ø¯: ${d.count}<br>Ø³Ø§Ø¹Ø§Øª ØªØ´ØºÙŠÙ„: ${d.hrs} Ø³Ø§Ø¹Ø©/ÙŠÙˆÙ…<hr><p class="tiny">${d.name} â€” Ù…ÙˆØ§ØµÙØ§Øª ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©.</p>`;
  modalBackdrop.style.display = 'flex';
}

function editDevice(i){
  const d = devices[i];
  // prefill form
  // try to set deviceCategory & deviceType (best effort)
  // For simplicity, allow user to remove then re-add: we'll set values and remove
  deviceCount.value = d.count;
  deviceHours.value = d.hrs;
  // set deviceType value to match name (search)
  for(const cat in deviceCatalog){
    const found = deviceCatalog[cat].find(x=>x.name===d.name);
    if(found){ deviceCategory.value=cat; deviceCategory.dispatchEvent(new Event('change'));
      // Wait for options to populate then set deviceType
      setTimeout(()=> {
        for(let opt of deviceType.options) if(opt.textContent.includes(d.name)){ deviceType.value = opt.value; break;}
      },50);
      break;
    }
  }
  devices.splice(i,1);
  saveDevices();
  renderDevices();
}

function removeDevice(i){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ')) return;
  devices.splice(i,1);
  saveDevices();
  renderDevices();
}

function onClearAll(){
  if(!confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©ØŸ')) return;
  devices = [];
  saveDevices();
  renderDevices();
}

function saveDevices(){
  localStorage.setItem('shamsin.devices', JSON.stringify(devices));
}

/* ====== Settings ====== */
function saveSettings(){
  userSettings.reportTitle = reportTitleInput.value;
  localStorage.setItem('shamsin.settings', JSON.stringify(userSettings));
}

/* ====== Calculations ====== */

/* helper: panel temp coefficient model (approx) */
function temperatureFactor(tempC){
  // rough model: decrease ~0.4% per Â°C above 25Â°C
  const coeffPerDeg = 0.004; // 0.4% per Â°C
  const delta = tempC - 25;
  return 1 - Math.max(0, delta * coeffPerDeg);
}

/* helper: wire resistance R = rho * L / A
   approximate copper resistivity rho ~= 1.68e-8 ohmÂ·m, area conversion mm2 -> m2
   calculate voltage drop and power loss for DC, with I = P/V
*/
function wireLoss(powerW, voltage, lengthM, area_mm2) {
  const rho = 1.68e-8;
  const area_m2 = area_mm2 * 1e-6;
  const R = rho * (lengthM*2) / area_m2; // round trip (to and back)
  const I = powerW / voltage;
  const lossW = I*I*R;
  const lossPercent = (lossW / powerW)*100;
  return {lossW, lossPercent: lossPercent.toFixed(2)};
}

function calculateSystem(){
  if(devices.length===0){ alert('Ø£Ø¶Ù Ø¬Ù‡Ø§Ø²Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }

  // gather inputs
  const sunHours = parseFloat(sunHoursInput.value) || 5;
  const panelW = parseInt(panelWInput.value);
  const systemV = parseInt(systemVoltageInput.value);
  const batteryType = batteryTypeSelect.value;
  const batteryAh = parseInt(batteryAhSelect.value);
  const userDoD = parseFloat(batteryDoDSelect.value);
  const wireLength = parseFloat(wireLengthInput.value) || 10;
  const wireSize = parseFloat(wireSizeSelect.value);
  const ambientTemp = parseFloat(ambientTempInput.value) || 25;
  const panelPrice = parseFloat(panelPriceInput.value) || 120;

  // totals
  let totalWh = 0;
  let peakLoad = 0;
  devices.forEach(d=>{
    const load = d.power * d.count;
    const daily = load * d.hrs;
    totalWh += daily;
    if(load > peakLoad) peakLoad = load;
  });

  // apply ambient temp factor
  const tempFactor = temperatureFactor(ambientTemp);

  // system loss assumptions: inverter, wiring, mismatch, battery roundtrip => use user from battery spec + default loss factor
  const battSpec = batterySpecs[batteryType] || {eff:0.85, dod:0.5};
  const systemEfficiency = battSpec.eff * 0.96 * tempFactor; // approximate combined eff

  // panels needed (taking into account system efficiency and sun hours)
  const panelsNeeded = Math.ceil((totalWh / (sunHours * panelW * systemEfficiency)) );

  // battery storage: assume backup = 1 day by default (you can change)
  const backupDays = 1;
  const requiredKWh = (totalWh * backupDays); // Wh to kWh later
  // convert to Ah at system voltage, consider battery efficiency and DoD
  const dod = userDoD || battSpec.dod || 0.5;
  const batteryAhNeeded = Math.ceil((requiredKWh) / (systemV * battSpec.eff * dod) );
  const requiredBatteriesCount = Math.ceil(batteryAhNeeded / batteryAh);
  const batteryKwhTotal = (batteryAh * requiredBatteriesCount * systemV) / 1000;

  // inverter sizing: peakLoad + margin 25%
  const inverterW = Math.ceil(peakLoad * 1.25);

  // wire loss
  const wire = wireLoss(totalWh, systemV, wireLength, wireSize);

  // cost estimate
  const panelsCost = panelsNeeded * panelPrice;
  const batteryUnitPrice = batteryType==='li' ? 900 : 200; // rough estimates in USD
  const batteriesCost = requiredBatteriesCount * batteryUnitPrice;
  const inverterCost = inverterW/1000 * 300; // $300 per kW rough
  const totalCost = Math.round((panelsCost + batteriesCost + inverterCost) * 100) / 100;

  // update UI
  dailyKwhEl.textContent = (totalWh/1000).toFixed(2) + ' kWh';
  panelsCountEl.textContent = panelsNeeded + ' Ù„ÙˆØ­';
  batteryNeededAhEl.textContent = batteryAhNeeded + ' Ah';
  batteryCountEl.textContent = requiredBatteriesCount + ' Ø¨Ø·Ø§Ø±ÙŠØ©';
  // update chart
  consumptionChart.data.datasets[0].data = [parseFloat((totalWh/1000).toFixed(2)), panelsNeeded * panelW];
  consumptionChart.update();

  // smart tips
  const tips = [];
  if(peakLoad > inverterW/1.25*0.9) tips.push('Ø­Ù…Ù„ Ø§Ù„Ø°Ø±ÙˆØ© Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø³Ø¹Ø© Ø§Ù„Ø¥Ù†ÙØ±ØªØ± â€” ÙÙƒØ± Ø¨Ø¥Ù†ÙØ±ØªØ± Ø£Ù‚ÙˆÙ‰.');
  if(batteryType==='li') tips.push('Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù„ÙŠØ«ÙŠÙˆÙ… Ø£ØºÙ„Ù‰ Ù„ÙƒÙ† Ø¹Ù…Ø±Ù‡Ø§ Ø£Ø·ÙˆÙ„ ÙˆÙƒÙØ§Ø¡Ø© Ø£Ø¹Ù„Ù‰.');
  tips.push(`ØªÙ‚Ø¯ÙŠØ± Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ: ${totalCost} USD (Ø£Ù„ÙˆØ§Ø­: ${panelsCost}ØŒ Ø¨Ø·Ø§Ø±ÙŠØ§Øª: ${batteriesCost}ØŒ Ø¥Ù†ÙØ±ØªØ±: ${Math.round(inverterCost)})`);
  renderTips(tips);

  // summary area population
  const content = `
    <div>
      <div class="tiny small-muted">Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„ÙƒÙ„ÙŠ (ØªÙ‚Ø¯ÙŠØ±ÙŠ)</div>
      <div style="font-weight:800;color:var(--primary);font-size:18px">${(totalWh/1000).toFixed(2)} kWh</div>
    </div>
    <div style="margin-top:10px">
      <div class="tiny small-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ø­ (${panelW} W)</div>
      <div style="font-weight:800">${panelsNeeded} Ù„ÙˆØ­</div>
    </div>
    <div style="margin-top:10px">
      <div class="tiny small-muted">Ø­Ø¬Ù… Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª</div>
      <div style="font-weight:800">${batteryAhNeeded} Ah â€” (${requiredBatteriesCount} Ø¨Ø·Ø§Ø±ÙŠØ© Ã— ${batteryAh}Ah)</div>
    </div>
    <div style="margin-top:10px">
      <div class="tiny small-muted">Ø§Ù„Ø§Ù†ÙØ±ØªØ± Ø§Ù„Ù…Ù‚ØªØ±Ø­</div>
      <div style="font-weight:800">${inverterW} W</div>
    </div>
    <div style="margin-top:10px">
      <div class="tiny small-muted">ÙÙ‚Ø¯ Ø§Ù„Ø³Ù„Ùƒ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ</div>
      <div style="font-weight:800">${parseFloat(wire.lossW).toFixed(2)} W (${wire.lossPercent}%)</div>
    </div>
    <div style="margin-top:10px">
      <div class="tiny small-muted">ØªÙƒÙ„ÙØ© ØªÙ‚Ø¯ÙŠØ±ÙŠØ©</div>
      <div style="font-weight:800">${totalCost} USD</div>
    </div>
  `;
  document.getElementById('results-content').innerHTML = content;
  resultsSectionShow();

  // save summary to local storage
  const summary = {
    totalWh, panelsNeeded, batteryAhNeeded, requiredBatteriesCount, inverterW, totalCost, date: new Date().toISOString()
  };
  localStorage.setItem('shamsin.lastSummary', JSON.stringify(summary));
}

/* show results card */
function resultsSectionShow(){ document.getElementById('results').style.display='block'; }

/* render tips */
function renderTips(arr){
  smartTipsEl.innerHTML = '';
  arr.forEach(a=>{
    const li = document.createElement('li'); li.textContent = a;
    smartTipsEl.appendChild(li);
  });
}

/* ====== Sharing & PDF ====== */
function shareToWhatsapp(){
  const text = document.getElementById('results-content').innerText || 'Ù†ØªØ§Ø¦Ø¬ Ø´Ù…Ø³ÙŠÙ†';
  const url = 'https://wa.me/?text=' + encodeURIComponent(text);
  window.open(url, '_blank');
}
function shareToEmail(){
  const subject = encodeURIComponent(reportTitleInput.value || 'Ù†ØªØ§Ø¦Ø¬ Ø´Ù…Ø³ÙŠÙ†');
  const body = encodeURIComponent(document.getElementById('results-content').innerText || '');
  window.location.href = `mailto:?subject=${subject}&body=${body}`;
}

async function savePdf(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4', orientation:'portrait'});
  const title = reportTitleInput.value || 'ØªÙ‚Ø±ÙŠØ± Ø´Ù…Ø³ÙŠÙ†';
  doc.setFontSize(18);
  doc.text(title, 40, 40);
  doc.setFontSize(12);
  const summaryText = document.getElementById('results-content').innerText || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬';
  const lines = doc.splitTextToSize(summaryText, 520);
  doc.text(lines, 40, 80);
  doc.save((title || 'shamsin_report') + '.pdf');
}

/* ====== Persistence for settings & last summary ====== */
function saveSettingsOnChange(){
  userSettings.reportTitle = reportTitleInput.value;
  localStorage.setItem('shamsin.settings', JSON.stringify(userSettings));
}
reportTitleInput.addEventListener('input', saveSettingsOnChange);

/* ====== initial render ====== */
renderDevices();

/* ====== Expose some funcs to global for buttons in table */ 
window.showDevice = showDevice;
window.editDevice = editDevice;
window.removeDevice = removeDevice;

/* ====== Small improvements: auto-save when leaving inputs ====== */
[ sunHoursInput, panelWInput, systemVoltageInput, batteryTypeSelect, batteryAhSelect, batteryDoDSelect, wireLengthInput, wireSizeSelect, ambientTempInput, panelPriceInput ].forEach(el=>{
  el.addEventListener('change', ()=> { userSettings.lastInputs = {
    sunHours: sunHoursInput.value, panelW: panelWInput.value, systemV: systemVoltageInput.value
  }; saveSettings(); });
});
</script>
</body>
  </html>
